<html>
    <head>
        <script
            src="https://github.com/stan-dev/stanc3/releases/download/nightly/stanc.js"></script>
        <script
            src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="prism.js"></script>
        <script src="demo.js"></script>
        <script>
            function canonicalizer(line_length) {
                let line_length_arg = "max-line-length=" + line_length.toString()
                let args = ["auto-format", line_length_arg]
                let canonicalize_modes = ""
                if ($("#parentheses")[0].checked) {
                    canonicalize_modes += "parentheses"
                }
                if ($("#braces")[0].checked) {
                    if (canonicalize_modes.length > 0) {
                        canonicalize_modes += ","
                    }
                    canonicalize_modes += "braces"
                }
                if ($("#deprecations")[0].checked) {
                    if (canonicalize_modes.length > 0) {
                        canonicalize_modes += ","
                    }
                    canonicalize_modes += "deprecations"
                }
                if (canonicalize_modes.length > 0) {
                    args.push("canonicalize="+canonicalize_modes)
                }
                var model = stanc("test_model",$("#model").val(), args);
                    
                if(model.errors) {
                    $("#error").html(model.errors[1]);
                    $("#result").html("");
                } else {
                    $("#result").html(Prism.highlight(model.result, Prism.languages.stan, 'stan'));
                    $("#error").html("");
                }
            }
            $(document).ready(function(){
                let model_url = GetURLParameter("model")
                let line_length = GetURLParameter("line_length")
                if (!line_length) {
                    line_length = 78
                } else {
                    $("#line-length").val(line_length)
                }
                let model = "cGFyYW1ldGVycyB7CiAgcmVhbCB5WzVdOwogIHJlYWwgeDsKfQptb2RlbCB7CiAgZm9yIChpIGluIDEgOiA1KSB7CiAgICB0YXJnZXQgKz0gbm9ybWFsX2xvZyh4LCB5W2ldLCAoMC41ICsgMSkpOwogIH0KfQ%3D%3D"
                if (model_url) {
                    model = model_url   
                }
                $("#model").val(atob(decodeURIComponent(model)))
                $("#model").focus(function () {
                    $("#url-box").html("");
                })
                $("#compile").click(function() {
                    line_length = $("#line-length").val()
                    canonicalizer(line_length);                    
                });
                canonicalizer(line_length);

                $("#url").click(function () {
                    let url = window.location.href.split('?')[0] + "?line_length="+ $("#line-length").val() + "&model=" + encodeURIComponent(btoa($("#model").val()))
                    $("#url-box").html(url);
                });
            });
        </script>
        <link rel="stylesheet" type="text/css" href="style.css?ver=5">
        <link href="prism.css" rel="stylesheet" />
        <title>Stan canonicalizer</title>
    </head>
    <body>
        <div class="page-links"><a class="selected" href="index.html">Print C++</a></div>
        <div class="page-links"><a href="pedantic.html">Pedantic check</a></div>
        <div class="page-links"><a href="signatures.html">Supported signatures</a></div>
        <div class="page-links"><a href="optimization.html">Optimization diff</a></div>
        <div class="page-links"><a href="autoformat.html">Auto format</a></div>
        <div class="page-links selected-link"><a href="canonicalizer.html">Canonicalizer</a></div>
        <textarea id="model" class="x" name="subject" style="height:200px"
            spellcheck="false"></textarea>
        <div class="buttons">
            <div class="action_btn">
                <button id="compile" class="action_btn submit">Print canonical</button>
                <button id="url" class="action_btn cancel">Generate URL</button>
                <p id="saved"></p>
            </div>
        </div>
        <input type="checkbox" name="parantheses" checked=checked
            id="parentheses" /> Parentheses
        <input type="checkbox" name="braces" checked=checked id="braces" />
        Braces
        <input type="checkbox" name="deprecations" checked=checked
            id="deprecations" /> Deprecations
        <br/><br/>
        Line length limit: <input type= "number" id="line-length" value = "78" style="width: 60px;" />
        <div id="url-box" class="error-box"></div>
        <div id="error" class="error-box"></div>
        <pre><code id = "result" class="language-cpp"></code></pre>
    </body>
</html>
